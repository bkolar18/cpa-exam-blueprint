================================================================================
CPA EXAM BLUEPRINT - CLAUDE CONTEXT
================================================================================
Last Updated: 2026-01-16

This is a comprehensive context file for Claude Code sessions. It contains
complete project history, workflow preferences, golden rules, and detailed
system structure.

================================================================================
TABLE OF CONTENTS
================================================================================

1. PROJECT IDENTITY
2. BUSINESS CONTEXT
3. TECHNICAL ARCHITECTURE
4. COMPLETE FILE STRUCTURE
5. WORKFLOW PREFERENCES
6. GOLDEN RULES
7. PROJECT HISTORY
8. DATABASE SCHEMA (Supabase - ACTIVE)
9. DATA MODELS
10. API REFERENCE
11. STYLING GUIDE
12. PRACTICE QUESTIONS SYSTEM
    12.5 EXAM SIMULATION SYSTEM
    12.6 TBS (TASK-BASED SIMULATION) SYSTEM
13. GAMIFICATION SYSTEM
14. AUTHENTICATION SYSTEM (Updated 2026-01-16)
15. ERROR TRACKING & GRACEFUL DEGRADATION (NEW 2026-01-16)
16. FUTURE ROADMAP
17. KEY DOCUMENTS REFERENCE

================================================================================
1. PROJECT IDENTITY
================================================================================

Name: Meridian CPA Review (formerly CPA Exam Blueprint)
Tagline: Free CPA Study Plans from Licensed CPAs
Domain: cpa-exam-blueprint.vercel.app (production)
Repository: https://github.com/bkolar18/cpa-exam-blueprint
Owner: bkolar18 (Brenn)

Purpose:
A full-service CPA review company providing comprehensive exam preparation
resources including practice questions, task-based simulations, study tools,
and personalized learning experiences to help candidates pass the CPA exam.

================================================================================
2. BUSINESS CONTEXT
================================================================================

TARGET AUDIENCE:
- CPA exam candidates (accounting students, career changers)
- Working professionals studying part-time
- Recent graduates preparing for the exam

VALUE PROPOSITION:
- Free personalized study plans (competitors charge for this)
- Free tools (score calendar, NTS tracker, calculator)
- State-specific requirement guides (55 states/jurisdictions)
- 6,065+ MCQ practice questions across all 6 sections
- ~500 TBS (Task-Based Simulation) questions across all 6 sections
- Exam simulation mode with timed tests and pause functionality
- User dashboard with progress tracking and gamification
- Prime Meridian exam readiness scoring system
- AI-powered flashcard generation
- Guidance from "licensed CPAs" (authority positioning)

BUSINESS MODEL:
- Full-service CPA review platform
- Subscription-based access to premium features
- Free tier with limited access to build trust
- Premium tier with full question bank, AI features, and analytics

COMPETITIVE DIFFERENTIATION:
| Competitors Do          | We Do Instead                    |
|-------------------------|----------------------------------|
| Expensive subscriptions | Affordable, value-focused pricing|
| Generic content         | Personalized study plans         |
| Outdated materials      | Current, blueprint-aligned content|
| Limited practice        | 6,065+ MCQs and ~500 TBS         |
| No progress tracking    | Full dashboard with gamification |
| No AI features          | AI-powered flashcards & analysis |

CPA EXAM STRUCTURE (CPA Evolution 2024+):
- 3 Core Sections: FAR, AUD, REG (continuous testing)
- 1 Discipline Section: BAR, TCP, or ISC (quarterly: Jan, Apr, Jul, Oct)
- 18-month rolling window to pass all sections
- Passing score: 75 on each section

PASS RATES (2024-2025):
- FAR: 40-43% (hardest core)
- AUD: 46-50%
- REG: 58-64%
- TCP: 72-82% (highest - easiest discipline)
- BAR: 33-40% (hardest overall)
- ISC: ~51%

================================================================================
3. TECHNICAL ARCHITECTURE
================================================================================

FRAMEWORK & RUNTIME:
- Next.js 16.1.1 (App Router)
- React 19
- TypeScript
- Node.js

STYLING:
- Tailwind CSS v4
- CSS Variables for theming
- No component library (custom components)

DATABASE & AUTH (ACTIVE):
- Supabase (PostgreSQL)
- Supabase Auth (email/password)
- Cookie-based authentication (using @supabase/ssr)
- Row Level Security (RLS) enabled

EMAIL:
- Resend API for transactional emails
- Templates: HTML inline styles

DEPLOYMENT:
- Vercel (auto-deploy from GitHub main branch)
- Vercel Analytics enabled

AI FEATURES:
- Anthropic Claude API for:
  - Flashcard generation
  - Exam debrief analysis
  - Pre-exam assessment
  - Study guide generation
  - Weekly reports

ENVIRONMENT VARIABLES:
```
# Current (Active)
RESEND_API_KEY=re_XEVXzFPr_HsK9GPJzNhGorSNHrpsxo9dU
EMAIL_TO=delivered@resend.dev  # TODO: Set real admin email
NEXT_PUBLIC_SUPABASE_URL=<your-supabase-url>
NEXT_PUBLIC_SUPABASE_ANON_KEY=<your-anon-key>
ANTHROPIC_API_KEY=<for-ai-features>
```

================================================================================
4. COMPLETE FILE STRUCTURE
================================================================================

cpa-exam-blueprint/
├── .env.local                    # Environment variables (gitignored)
├── .gitignore
├── next.config.ts
├── package.json
├── tsconfig.json
├── tailwind.config.ts
│
├── docs/
│   ├── core/
│   │   ├── CLAUDE_CONTEXT.txt    # This file - comprehensive context
│   │   ├── SESSION_LOG.txt       # Session-by-session accomplishments
│   │   ├── SESSION_PROMPT.txt    # Quick start for new sessions
│   │   ├── CLAUDE.md             # Quick reference for Claude
│   │   ├── ANALYTICS.md          # Prime Meridian scoring system
│   │   ├── TOPIC-MAPPING.md      # AICPA content area mapping
│   │   └── archive/              # Historical documentation
│   ├── admin/
│   │   ├── SETUP.md
│   │   ├── EMAIL_INTEGRATION.md
│   │   └── database-schema.sql
│   └── claude instructions/
│       ├── TODO.md               # Current task list
│       └── troubleshooting.txt
│
├── supabase/
│   └── migrations/               # SQL migration files
│
├── scripts/
│   ├── validate-tbs.js           # TBS validation script
│   ├── check-blueprint-alignment.js  # AICPA alignment checker
│   └── ...
│
├── public/
│   └── (static assets)
│
└── src/
    ├── app/
    │   ├── globals.css           # Design system, CSS variables
    │   ├── layout.tsx            # Root layout with Header/Footer
    │   ├── page.tsx              # Home page
    │   ├── sitemap.ts            # Dynamic sitemap generation
    │   │
    │   ├── api/
    │   │   ├── submit-study-plan/route.ts
    │   │   ├── subscribe-score-release/route.ts
    │   │   ├── subscribe-nts/route.ts
    │   │   ├── feedback/route.ts
    │   │   ├── navigator/route.ts
    │   │   ├── ai/
    │   │   │   ├── exam-debrief/route.ts
    │   │   │   ├── generate-flashcard/route.ts
    │   │   │   ├── generate-flashcards/route.ts
    │   │   │   ├── pre-exam-assessment/route.ts
    │   │   │   ├── study-guide/route.ts
    │   │   │   └── weekly-report/route.ts
    │   │   ├── tbs/
    │   │   │   ├── attempts/route.ts       # GET/POST TBS attempts
    │   │   │   ├── attempts/[id]/route.ts  # Individual attempt
    │   │   │   ├── stats/route.ts          # TBS statistics
    │   │   │   └── questions/route.ts      # TBS questions
    │   │   ├── admin/
    │   │   │   ├── activity/route.ts
    │   │   │   ├── analytics/route.ts
    │   │   │   ├── announcements/route.ts
    │   │   │   ├── feedback/route.ts
    │   │   │   ├── questions/route.ts
    │   │   │   └── users/route.ts
    │   │   ├── email/
    │   │   │   ├── preview/route.ts
    │   │   │   ├── process-queue/route.ts
    │   │   │   ├── test/route.ts
    │   │   │   └── webhook/route.ts
    │   │   └── csp-report/route.ts
    │   │
    │   ├── auth/
    │   │   └── callback/route.ts     # Supabase auth callback
    │   │
    │   ├── login/page.tsx
    │   ├── signup/page.tsx
    │   ├── forgot-password/page.tsx
    │   ├── reset-password/page.tsx
    │   │
    │   ├── admin/
    │   │   ├── layout.tsx
    │   │   ├── page.tsx              # Admin dashboard
    │   │   ├── activity/page.tsx
    │   │   ├── analytics/page.tsx
    │   │   ├── announcements/page.tsx
    │   │   ├── feedback/page.tsx
    │   │   ├── questions/page.tsx
    │   │   ├── security/page.tsx
    │   │   └── users/page.tsx
    │   │
    │   ├── dashboard/
    │   │   ├── layout.tsx            # Dashboard layout with nav + auth protection
    │   │   ├── page.tsx              # Main dashboard overview
    │   │   ├── study-log/page.tsx    # Log study sessions
    │   │   ├── nts/page.tsx          # Manage NTS entries
    │   │   ├── practice/
    │   │   │   ├── page.tsx          # Practice overview
    │   │   │   ├── [section]/page.tsx # Section practice questions
    │   │   │   └── history/page.tsx  # Review past attempts
    │   │   ├── exam-simulation/
    │   │   │   ├── page.tsx          # Simulation config
    │   │   │   ├── [section]/page.tsx # Timed exam with pause
    │   │   │   ├── history/[id]/page.tsx
    │   │   │   └── debrief/[examId]/page.tsx
    │   │   ├── simulations/
    │   │   │   ├── page.tsx          # TBS simulation library
    │   │   │   ├── [id]/page.tsx     # Individual TBS
    │   │   │   ├── section/[section]/page.tsx
    │   │   │   └── review/[attemptId]/page.tsx
    │   │   ├── flashcards/
    │   │   │   ├── page.tsx          # Flashcard overview
    │   │   │   ├── [section]/page.tsx
    │   │   │   └── review/page.tsx
    │   │   ├── readiness/
    │   │   │   ├── page.tsx          # Exam readiness dashboard (Prime Meridian)
    │   │   │   └── assessment/[section]/page.tsx
    │   │   ├── analytics/page.tsx    # User analytics
    │   │   ├── my-notes/page.tsx     # User notes hub
    │   │   ├── flagged-questions/page.tsx
    │   │   ├── accolades/page.tsx    # Badges and achievements
    │   │   └── settings/page.tsx     # User preferences
    │   │
    │   ├── study-plan/page.tsx       # 5-step quiz with email capture
    │   ├── cpa-academy/page.tsx      # CPA Academy landing page
    │   ├── pricing/page.tsx          # Pricing page
    │   ├── faq/page.tsx              # FAQ page
    │   │
    │   ├── sections/
    │   │   ├── far/page.tsx
    │   │   ├── aud/page.tsx
    │   │   ├── reg/page.tsx
    │   │   ├── tcp/page.tsx
    │   │   ├── bar/page.tsx
    │   │   └── isc/page.tsx
    │   │
    │   ├── tools/
    │   │   ├── score-release-calendar/page.tsx
    │   │   ├── nts-tracker/page.tsx
    │   │   └── study-hours-calculator/page.tsx
    │   │
    │   ├── state-requirements/
    │   │   ├── page.tsx              # State grid landing page
    │   │   └── [state]/page.tsx      # Dynamic state pages (55 states)
    │   │
    │   ├── resources/
    │   │   ├── page.tsx
    │   │   ├── cpa-pass-rates/page.tsx
    │   │   └── cpa-salary/
    │   │       ├── page.tsx
    │   │       └── [state]/page.tsx
    │   │
    │   ├── blog/
    │   │   ├── page.tsx              # Blog listing
    │   │   └── [slug]/page.tsx       # Individual blog posts
    │   │
    │   ├── guides/
    │   │   ├── exam-day/page.tsx
    │   │   ├── failed-section/page.tsx
    │   │   ├── how-to-become-a-cpa/page.tsx
    │   │   ├── best-order-cpa-exams/page.tsx
    │   │   └── become-cpa-in/
    │   │       ├── page.tsx
    │   │       └── [state]/page.tsx
    │   │
    │   ├── compare/
    │   │   ├── becker-vs-surgent/page.tsx
    │   │   ├── becker-vs-gleim/page.tsx
    │   │   ├── surgent-vs-roger/page.tsx
    │   │   └── wiley-vs-uworld/page.tsx
    │   │
    │   ├── topics/                   # SEO topic pages
    │   │   ├── aud/...
    │   │   ├── far/...
    │   │   └── reg/...
    │   │
    │   └── support/page.tsx
    │
    ├── components/
    │   ├── Header.tsx                # Navigation with dropdowns
    │   ├── Footer.tsx                # Site footer
    │   ├── SectionPage.tsx           # Reusable section template
    │   ├── LayoutWrapper.tsx
    │   ├── ErrorBoundary.tsx         # React error boundary (NEW 2026-01-16)
    │   │
    │   ├── auth/
    │   │   ├── AuthProvider.tsx      # Auth context with graceful degradation
    │   │   ├── AuthErrorBanner.tsx   # Auth error UI component (NEW 2026-01-16)
    │   │   └── InactivityWarning.tsx
    │   │
    │   ├── dashboard/
    │   │   ├── DashboardNav.tsx
    │   │   ├── PrimeMeridianScore.tsx # Exam readiness score display
    │   │   └── ...
    │   │
    │   ├── tbs/
    │   │   ├── TBSContainer.tsx      # Main TBS UI with exit session
    │   │   ├── TBSHeader.tsx
    │   │   ├── WorkArea.tsx
    │   │   ├── ExhibitPanel.tsx
    │   │   └── ...
    │   │
    │   ├── practice/
    │   │   └── ...
    │   │
    │   ├── flashcards/
    │   │   └── ...
    │   │
    │   ├── gamification/
    │   │   ├── AchievementProvider.tsx
    │   │   └── ...
    │   │
    │   ├── navigator/                # Meridian Navigator chat
    │   │   └── ...
    │   │
    │   ├── admin/
    │   │   └── ...
    │   │
    │   ├── seo/
    │   │   └── ...
    │   │
    │   ├── animations/
    │   │   └── ...
    │   │
    │   └── theme/
    │       └── ThemeProvider.tsx
    │
    └── lib/
        ├── errorTracking.ts          # Centralized error tracking (NEW 2026-01-16)
        │
        ├── supabase/
        │   ├── client.ts             # Browser client (createBrowserClient from @supabase/ssr)
        │   ├── server.ts             # Server Supabase client
        │   ├── middleware.ts         # Session refresh middleware
        │   ├── clearAuthStorage.ts
        │   └── types.ts              # Database types (Profile, etc.)
        │
        ├── gamification/
        │   ├── types.ts              # Badge, Achievement types
        │   ├── badges.ts             # Badge definitions
        │   ├── points.ts             # Point calculations
        │   └── checker.ts            # Achievement trigger logic
        │
        ├── scoring/
        │   ├── prime-meridian.ts     # Prime Meridian score calculation
        │   └── taxonomy.ts           # AICPA topic taxonomy
        │
        ├── adaptive/
        │   └── ...                   # Adaptive question selection
        │
        ├── ai/
        │   └── ...                   # AI feature utilities
        │
        ├── email/
        │   └── ...                   # Email utilities
        │
        ├── security/
        │   └── ...                   # Security utilities
        │
        ├── admin/
        │   └── ...                   # Admin utilities
        │
        ├── blog/
        │   └── ...                   # Blog utilities
        │
        ├── flashcards/
        │   └── ...                   # Flashcard utilities
        │
        ├── resend/
        │   └── ...                   # Resend email integration
        │
        └── data/
            ├── practice-questions/
            │   ├── types.ts          # QuestionSet, PracticeQuestion
            │   ├── index.ts          # Exports and helper functions
            │   ├── far.ts            # FAR questions
            │   ├── aud.ts            # AUD questions
            │   ├── reg.ts            # REG questions
            │   ├── tcp.ts            # TCP questions
            │   ├── bar.ts            # BAR questions
            │   └── isc.ts            # ISC questions
            │
            ├── tbs/
            │   ├── types.ts          # TBS type definitions
            │   ├── index.ts          # Central exports
            │   ├── far-tbs.ts        # FAR TBS questions
            │   ├── aud-tbs.ts        # AUD TBS questions
            │   ├── reg-tbs.ts        # REG TBS questions
            │   ├── tcp-tbs.ts        # TCP TBS questions
            │   ├── bar-tbs.ts        # BAR TBS questions
            │   ├── isc-tbs.ts        # ISC TBS questions
            │   ├── sample-tbs.ts     # Sample TBS
            │   └── exam-tbs.ts       # Exam TBS
            │
            ├── score-release-dates.ts
            └── state-requirements.ts

================================================================================
5. WORKFLOW PREFERENCES
================================================================================

DEVELOPMENT:
- Always run `npm run build` to verify before committing
- Commit frequently with descriptive messages
- Push to trigger Vercel auto-deploy

GIT CONVENTIONS:
- Main branch only (no feature branches for this project)
- Commit messages: Clear, descriptive, include scope
- Always include Claude Code and Happy attribution in commits

FILE ORGANIZATION:
- Keep related files together (page + its data)
- Use lib/data/ for static data files
- Prefer editing existing files over creating new ones

CODE STYLE:
- TypeScript strict mode
- Functional components with hooks
- CSS variables for colors (not hardcoded)
- Tailwind utility classes

DOCUMENTATION:
- Update SESSION_LOG.txt after each session
- Update CLAUDE_CONTEXT.txt when major changes occur
- Session files (SESSION_*.txt, CLAUDE_CONTEXT.txt) are local - don't push every time

================================================================================
6. GOLDEN RULES
================================================================================

**CRITICAL - TOP PRIORITY:**

1. SESSION FILES ARE LOCAL: Do NOT push these to GitHub every update:
   - SESSION_PROMPT.txt
   - SESSION_LOG.txt
   - CLAUDE_CONTEXT.txt
   - Only push when committing actual code changes or when explicitly requested

2. READ DOCS BEFORE TBS WORK: Before creating ANY TBS questions:
   - Read docs/core/CLAUDE.md for type definitions
   - Check TBS batch size limit (10 questions max per batch)
   - Verify content areas match section

**STANDARD RULES:**
3. ALWAYS read SESSION_PROMPT.txt at session start
4. ALWAYS update SESSION_LOG.txt at session end
5. NEVER commit .env.local or expose API keys
6. ALWAYS run `npm run build` before committing code
7. PREFER editing existing files over creating new ones
8. KEEP the design consistent (use CSS variables)
9. CAPTURE emails at every opportunity (lead generation focus)
10. MAINTAIN mobile responsiveness on all pages
11. WRITE code that compiles - verify with build
12. DOCUMENT major decisions in this file

================================================================================
7. PROJECT HISTORY
================================================================================

PHASE 0: Initial Setup (Completed)
----------------------------------
- Created Next.js project with TypeScript
- Set up Tailwind CSS v4 with CSS variables
- Built core pages: Home, Study Plan, Sections, About
- Created Header/Footer components
- Implemented study plan quiz with email capture
- Integrated Resend API for emails
- Deployed to Vercel
- Added Vercel Analytics

PHASE 1: Free Tools (Completed 2026-01-03)
------------------------------------------
- Score Release Calendar with countdown timer
- NTS Expiration Tracker with reminder system
- Study Hours Calculator for all 6 sections
- State Requirements Guide (55 states/jurisdictions)
- Enhanced Study Plan with discipline selection
- Added "Free Tools" dropdown to navigation

PHASE 2: Content & Authority (Completed 2026-01-04)
---------------------------------------------------
- MDX blog infrastructure
- 8 blog posts (study guides, pass rates, working full-time, etc.)
- Exam Day Walkthrough guide
- "I Failed, Now What?" retaker guide
- Success Stories section (5 stories)
- Simplified header navigation

PHASE 3: CPA Academy / Dashboard (Completed, Enhanced through 2026-01-16)
------------------------------------------------------------------------
- Supabase database integration (PostgreSQL)
- User authentication (email/password via Supabase Auth)
- Cookie-based authentication using @supabase/ssr
- User dashboard with study tracking
- Study session logging with streak tracking
- Section progress management
- NTS tracking in dashboard
- Gamification system (points, badges, achievements)
- 5,810 MCQ practice questions across all 6 sections
- 470+ TBS questions across all 6 sections
- Practice history and accuracy tracking
- Exam simulation mode with timed tests and pause functionality
- TBS simulations with exit/resume functionality
- Prime Meridian exam readiness scoring system
- AI-powered flashcard generation
- Surgent promotional banner (per-account, 30-day reappearance)
- State requirements expanded to 55 states
- Admin dashboard for content management
- Graceful degradation for auth failures (NEW 2026-01-16)
- Error tracking infrastructure (NEW 2026-01-16)

PHASE 4: Email Nurturing (NOT STARTED)
--------------------------------------
- 7-email welcome sequence
- Segment-based content delivery
- Automated score release notifications

PHASE 5: AI Features (PARTIALLY COMPLETE)
-----------------------------------------
- AI flashcard generation (DONE)
- AI exam debrief (DONE)
- AI pre-exam assessment (DONE)
- AI study guide generation (DONE)
- AI chatbot (Meridian Navigator) - partially implemented

================================================================================
8. DATABASE SCHEMA (Supabase - ACTIVE)
================================================================================

The database is fully integrated and active. All tables have Row Level Security.

```sql
-- PROFILES TABLE
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  email TEXT UNIQUE NOT NULL,
  full_name TEXT,
  state_code TEXT,
  target_completion_date DATE,
  discipline_choice TEXT CHECK (discipline_choice IN ('TCP', 'BAR', 'ISC')),
  weekly_study_hours INTEGER,
  working_full_time BOOLEAN,
  -- Gamification fields
  total_points INTEGER DEFAULT 0,
  badge_count INTEGER DEFAULT 0,
  achievement_count INTEGER DEFAULT 0,
  current_streak INTEGER DEFAULT 0,
  longest_streak INTEGER DEFAULT 0,
  last_study_date DATE,
  promo_dismissed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- STUDY SESSIONS TABLE
CREATE TABLE study_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  section TEXT NOT NULL CHECK (section IN ('FAR', 'AUD', 'REG', 'TCP', 'BAR', 'ISC')),
  date DATE NOT NULL,
  hours DECIMAL(4,2) NOT NULL,
  notes TEXT,
  topics_covered TEXT[],
  created_at TIMESTAMPTZ DEFAULT now()
);

-- SECTION PROGRESS TABLE
CREATE TABLE section_progress (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  section TEXT NOT NULL CHECK (section IN ('FAR', 'AUD', 'REG', 'TCP', 'BAR', 'ISC')),
  status TEXT NOT NULL CHECK (status IN ('not_started', 'studying', 'scheduled', 'passed', 'failed')),
  start_date DATE,
  exam_date DATE,
  score INTEGER,
  attempt_number INTEGER DEFAULT 1,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(user_id, section)
);

-- NTS ENTRIES TABLE
CREATE TABLE nts_entries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  section TEXT NOT NULL CHECK (section IN ('FAR', 'AUD', 'REG', 'TCP', 'BAR', 'ISC')),
  issue_date DATE NOT NULL,
  expiration_date DATE NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('active', 'used', 'expired')),
  exam_scheduled_date DATE,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- PRACTICE ATTEMPTS TABLE
CREATE TABLE practice_attempts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  question_id TEXT NOT NULL,
  section TEXT NOT NULL CHECK (section IN ('FAR', 'AUD', 'REG', 'TCP', 'BAR', 'ISC')),
  topic TEXT,
  selected_answer TEXT NOT NULL,
  correct_answer TEXT NOT NULL,
  is_correct BOOLEAN NOT NULL,
  time_spent_seconds INTEGER,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- TBS ATTEMPTS TABLE (Updated schema)
CREATE TABLE tbs_attempts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  tbs_id TEXT NOT NULL,  -- String ID like "far-i-1-1-je"
  section TEXT CHECK (section IN ('FAR', 'AUD', 'REG', 'TCP', 'BAR', 'ISC')),
  responses JSONB,
  score_earned INTEGER,
  score_possible INTEGER,
  score_percentage DECIMAL(5,2),
  time_spent_seconds INTEGER,
  is_complete BOOLEAN DEFAULT false,
  started_at TIMESTAMPTZ DEFAULT now(),
  completed_at TIMESTAMPTZ,
  UNIQUE(user_id, tbs_id)
);

-- USER BADGES TABLE
CREATE TABLE user_badges (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  badge_id TEXT NOT NULL,
  earned_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(user_id, badge_id)
);

-- QUESTION NOTES TABLE
CREATE TABLE question_notes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  question_id TEXT NOT NULL,
  question_type TEXT NOT NULL CHECK (question_type IN ('mcq', 'tbs')),
  section TEXT NOT NULL CHECK (section IN ('FAR', 'AUD', 'REG', 'TCP', 'BAR', 'ISC')),
  note_content TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(user_id, question_id, question_type)
);

-- Indexes for performance
CREATE INDEX idx_study_sessions_user_date ON study_sessions(user_id, date);
CREATE INDEX idx_practice_attempts_user ON practice_attempts(user_id);
CREATE INDEX idx_section_progress_user ON section_progress(user_id);
CREATE INDEX idx_tbs_attempts_section ON tbs_attempts(section);
CREATE INDEX idx_tbs_attempts_user_section ON tbs_attempts(user_id, section);
```

================================================================================
9. DATA MODELS
================================================================================

PROFILE (TypeScript):
```typescript
interface Profile {
  id: string;
  email: string;
  full_name: string | null;
  state_code: string | null;
  target_completion_date: string | null;
  discipline_choice: 'TCP' | 'BAR' | 'ISC' | null;
  weekly_study_hours: number | null;
  working_full_time: boolean | null;
  total_points: number;
  badge_count: number;
  achievement_count: number;
  current_streak: number;
  longest_streak: number;
  last_study_date: string | null;
  promo_dismissed_at: string | null;
  created_at: string;
  updated_at: string;
}
```

PRACTICE QUESTION:
```typescript
interface PracticeQuestion {
  id: string;
  section: SectionCode;
  topic: string;
  difficulty: 'easy' | 'medium' | 'hard';
  question: string;
  options: { A: string; B: string; C: string; D: string; };
  correctAnswer: 'A' | 'B' | 'C' | 'D';
  explanation: string;
  tip?: string;
}
```

TBS QUESTION:
```typescript
interface TBSQuestion {
  id: string;
  section: SectionCode;
  tbsType: TBSType;
  topic: string;
  subtopic: string;
  difficulty: Difficulty;
  skillLevel: SkillLevel;
  contentArea: string;
  title: string;
  scenarioText: string;
  timeEstimateMinutes: number;
  maxScorePoints: number;
  exhibits: TBSExhibit[];
  requirements: TBSRequirement[];
  journalAccounts?: JournalAccount[];
}
```

================================================================================
10. API REFERENCE
================================================================================

POST /api/submit-study-plan
---------------------------
Sends formatted study plan email to user and admin notification.

POST /api/subscribe-score-release
---------------------------------
Subscribes user to score release notifications.

POST /api/subscribe-nts
-----------------------
Subscribes user to NTS expiration reminders.

GET/POST /api/tbs/attempts
--------------------------
Get user's TBS attempts or create new attempt.

GET /api/tbs/stats
------------------
Get user's TBS statistics by section.

POST /api/ai/generate-flashcard
-------------------------------
Generate AI-powered flashcard for a topic.

POST /api/ai/exam-debrief
-------------------------
Generate AI analysis of exam simulation results.

================================================================================
11. STYLING GUIDE
================================================================================

CSS VARIABLES (defined in globals.css):
```css
:root {
  --background: #ffffff;
  --foreground: #1a1a2e;
  --primary: #1e3a5f;        /* Navy blue - main brand */
  --primary-light: #2d5a87;
  --primary-dark: #152a45;
  --secondary: #16a34a;      /* Green - CTAs, success */
  --secondary-light: #22c55e;
  --accent: #0ea5e9;         /* Blue - links, highlights */
  --muted: #64748b;          /* Gray - secondary text */
  --muted-light: #94a3b8;
  --border: #e2e8f0;
  --card: #f8fafc;           /* Light gray - backgrounds */
}
```

SECTION COLORS:
```typescript
const sectionColors = {
  FAR: "#1e3a5f",  // Navy (primary)
  AUD: "#0891b2",  // Cyan
  REG: "#7c3aed",  // Purple
  TCP: "#16a34a",  // Green (secondary)
  BAR: "#dc2626",  // Red
  ISC: "#ea580c",  // Orange
};
```

================================================================================
12. PRACTICE QUESTIONS SYSTEM
================================================================================

OVERVIEW:
- 5,810 total MCQ questions across 176 batch files
- Immediate feedback with explanations
- Accuracy tracking by section
- History review with filtering
- Exam simulation mode with timed tests

QUESTION DISTRIBUTION (as of 2026-01-10):
| Section | Questions | Easy% | Med% | Hard% |
|---------|-----------|-------|------|-------|
| FAR     | 1,680     | 19%   | 46%  | 35%   |
| AUD     | 1,015     | 18%   | 52%  | 30%   |
| REG     | 1,260     | 16%   | 47%  | 36%   |
| TCP     | 805       | 17%   | 51%  | 32%   |
| BAR     | 490       | 17%   | 56%  | 27%   |
| ISC     | 560       | 15%   | 50%  | 35%   |

================================================================================
12.5 EXAM SIMULATION SYSTEM
================================================================================

OVERVIEW:
Timed practice tests mimicking the real CPA exam with pause functionality.

EXAM STATES:
- 'setup': Configure exam (question count, time limit)
- 'exam': Active exam with timer running
- 'paused': Exam paused, timer stopped
- 'review': Review answers before submission
- 'results': View final score and explanations

EXAM CONFIGS:
- MCQ Only: Just multiple choice questions
- Mixed Practice: MCQ + 1 TBS
- Realistic Testlet: MCQ + 2 TBS

================================================================================
12.6 TBS (TASK-BASED SIMULATION) SYSTEM
================================================================================

OVERVIEW:
470+ TBS questions simulating the actual CPA exam format.

TBS TYPES:
- numeric_entry: Calculate and enter numeric values
- document_review: Review documents, identify errors
- journal_entry: Create journal entries with debits/credits
- dropdown: Select from option lists
- research: Find authoritative literature citations

TBS DISTRIBUTION (as of 2026-01-11):
| Section | Questions |
|---------|-----------|
| FAR     | ~90+      |
| AUD     | ~90+      |
| REG     | ~80+      |
| TCP     | ~80+      |
| BAR     | ~80+      |
| ISC     | ~50+      |

EXIT SESSION FEATURE:
- Save & Exit: Saves progress as incomplete attempt
- Exit Without Saving: Exits without database save
- Shows progress summary (questions answered, time spent)

================================================================================
13. GAMIFICATION SYSTEM
================================================================================

POINTS:
- Study session: 10 points per hour logged
- Practice question correct: 5 points
- Practice question incorrect: 1 point
- Section passed: 100 points

STREAKS:
- Tracked by consecutive days with logged study sessions
- Current and longest streak stored in profile

BADGES:
- First Study Session
- 7-Day Streak, 30-Day Streak
- 100 Practice Questions, etc.
- Section Passed (per section)
- CPA Complete

================================================================================
14. AUTHENTICATION SYSTEM (Updated 2026-01-16)
================================================================================

ARCHITECTURE:
- Cookie-based auth using @supabase/ssr (NOT localStorage)
- Session refresh via middleware on each request
- Graceful degradation on auth failures

KEY FILES:
- src/lib/supabase/client.ts: Uses createBrowserClient from @supabase/ssr
- src/lib/supabase/middleware.ts: Refreshes auth tokens
- src/lib/supabase/server.ts: Server-side client for API routes
- src/components/auth/AuthProvider.tsx: Auth context with error handling

AUTH CONTEXT PROVIDES:
```typescript
interface AuthContextType {
  user: User | null;
  profile: Profile | null;
  session: Session | null;
  loading: boolean;
  error: AuthErrorType;  // 'network' | 'service_unavailable' | 'session_expired' | 'unknown' | null
  isServiceAvailable: boolean;
  signOut: () => Promise<void>;
  refreshProfile: () => Promise<void>;
  retryAuth: () => Promise<void>;
}
```

ERROR TYPES:
- 'network': Connection issues
- 'service_unavailable': Supabase service down
- 'session_expired': Token expired/invalid
- 'unknown': Other errors

================================================================================
15. ERROR TRACKING & GRACEFUL DEGRADATION (NEW 2026-01-16)
================================================================================

ERROR TRACKING (src/lib/errorTracking.ts):
- Centralized error capture and tracking
- Ready for Sentry integration
- Functions: captureException, captureMessage, trackAuthError, trackApiError
- User context tracking for error correlation

GRACEFUL DEGRADATION:
- AuthProvider classifies errors by type
- Dashboard layout shows error UI instead of redirecting on network/service errors
- Users can retry authentication or sign in again
- Retry logic with progressive delays (up to 2 retries)

COMPONENTS:
- src/components/ErrorBoundary.tsx: React error boundary
- src/components/auth/AuthErrorBanner.tsx: User-friendly auth error UI
- AuthStatusIndicator: Minimal inline error indicator for headers

TO ADD SENTRY:
```bash
npx @sentry/wizard@latest -i nextjs
```
Then update errorTracking.ts to use Sentry instead of console logging.

================================================================================
16. FUTURE ROADMAP
================================================================================

IMMEDIATE (In Progress):
- [ ] MCQ medium difficulty expansion (49.2% → 55% target)
- [ ] TBS expansion to 500+ questions
- [ ] AICPA Blueprint alignment refinements

PHASE 4 (Not Started):
- [ ] 7-email welcome sequence
- [ ] Email automation setup
- [ ] Segment-based content delivery

PHASE 5 (Partially Complete):
- [x] AI flashcard generation
- [x] AI exam debrief
- [x] AI pre-exam assessment
- [ ] AI chatbot (Meridian Navigator) - enhancement needed

LONG-TERM:
- [ ] Mobile app (PWA)
- [ ] Video content integration
- [ ] Community features
- [ ] Referral program

================================================================================
17. KEY DOCUMENTS REFERENCE
================================================================================

**Session Context:**
1. docs/core/SESSION_PROMPT.txt - Quick start for new sessions
2. docs/core/SESSION_LOG.txt - Session accomplishments
3. docs/claude instructions/TODO.md - Current task list

**Technical Reference:**
4. docs/core/CLAUDE.md - Quick reference for Claude
5. docs/core/ANALYTICS.md - Prime Meridian scoring system
6. docs/core/TOPIC-MAPPING.md - AICPA content area mapping

**TBS Reference:**
7. src/lib/data/tbs/*.ts - TBS question files
8. src/lib/data/tbs/types.ts - TBS type definitions

**Auth Reference:**
9. src/lib/supabase/client.ts - Browser auth client
10. src/components/auth/AuthProvider.tsx - Auth context
11. src/lib/errorTracking.ts - Error tracking utilities

================================================================================
END OF CONTEXT FILE
================================================================================
