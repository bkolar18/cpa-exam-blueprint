================================================================================
CPA EXAM BLUEPRINT - SESSION PROMPT
================================================================================
Last Updated: 2026-01-16

IMPORTANT: Read this file at the start of each session to understand project
context and continue work seamlessly.

================================================================================
QUICK START - READ FIRST
================================================================================

1. This is a CPA exam prep lead generation site (Meridian CPA Review)
2. Tech stack: Next.js 16.1.1, React 19, TypeScript, Tailwind CSS v4, Supabase
3. Live URL: https://cpa-exam-blueprint.vercel.app
4. Repo: https://github.com/bkolar18/cpa-exam-blueprint

PROJECT DIRECTORY:
cd "C:\Users\brenn\Documents\Coding Projects\CPA Exam Site\cpa-exam-blueprint"

COMMON COMMANDS:
npm run dev        # Start dev server (localhost:3000)
npm run build      # Production build (ALWAYS run before committing)
git push           # Deploy to Vercel (auto-deploys from main)

================================================================================
CURRENT PROJECT STATE (as of 2026-01-16)
================================================================================

COMPLETED PHASES:
- Phase 1: Free Tools (Score Calendar, NTS Tracker, Study Calculator, 55 States)
- Phase 2: Content & Authority (Blog, Guides, Success Stories)
- Phase 3: CPA Academy / Dashboard (Auth, MCQs, TBS, Gamification, Admin)

CONTENT STATUS:
- MCQ Questions: 5,810 across 176 batch files (49.2% medium)
- TBS Questions: 470+ across all 6 sections
- State Requirements: 55 states/jurisdictions

RECENT MAJOR WORK (2026-01-16):
- Implemented industry-standard error tracking infrastructure
- Added graceful degradation for auth failures
- Created AuthErrorBanner component for user-friendly error UI
- Created ErrorBoundary for React error catching
- Updated AuthProvider with error state, retry logic, and service availability tracking

================================================================================
AUTH SYSTEM ARCHITECTURE (Updated 2026-01-16)
================================================================================

**CRITICAL: Cookie-based auth using @supabase/ssr (NOT localStorage)**

KEY FILES:
- src/lib/supabase/client.ts - Browser client (createBrowserClient)
- src/lib/supabase/middleware.ts - Session refresh middleware
- src/lib/supabase/server.ts - Server-side client for API routes
- src/components/auth/AuthProvider.tsx - Auth context with graceful degradation
- src/components/auth/AuthErrorBanner.tsx - Auth error UI
- src/lib/errorTracking.ts - Centralized error tracking

AUTH CONTEXT NOW PROVIDES:
```typescript
{
  user, profile, session, loading,
  error,              // 'network' | 'service_unavailable' | 'session_expired' | 'unknown' | null
  isServiceAvailable, // boolean
  signOut, refreshProfile, retryAuth
}
```

GRACEFUL DEGRADATION:
- Network/service errors show error UI instead of redirecting
- Users can retry authentication
- Progressive retry delays (300ms, 600ms)
- Only redirects to login when user is clearly not authenticated

================================================================================
KEY DOCUMENTS TO READ
================================================================================

**MUST READ FIRST (Before creating ANY TBS):**
1. docs/core/CLAUDE.md - Quick reference, TBS types, batch limits

**Session Context:**
2. docs/core/CLAUDE_CONTEXT.txt - Comprehensive project context
3. docs/core/SESSION_LOG.txt - Session-by-session accomplishments
4. docs/claude instructions/TODO.md - Current task list

**Technical Reference:**
5. docs/core/ANALYTICS.md - Prime Meridian scoring system
6. docs/core/TOPIC-MAPPING.md - AICPA content area mapping

================================================================================
IMMEDIATE PRIORITIES (Pick up here!)
================================================================================

**PRIORITY 1: Test Auth Flow**
- Test login/logout with various scenarios
- Verify graceful degradation works on network errors
- Confirm error tracking is capturing auth events

**PRIORITY 2: Content Expansion**
- TBS: 470+ → 500+ (add ~30 more)
- MCQ medium difficulty: 49.2% → 55% target

**PRIORITY 3: Other Tasks**
- Phase 4: Email Nurturing (not started)
- Phase 5: AI Features (partially complete)

================================================================================
FILE STRUCTURE HIGHLIGHTS
================================================================================

src/
├── app/
│   ├── api/                    # API routes
│   │   ├── tbs/                # TBS API (stats, attempts)
│   │   ├── ai/                 # AI features (flashcards, debrief)
│   │   └── admin/              # Admin API
│   ├── dashboard/              # Protected user dashboard
│   │   ├── practice/           # MCQ practice
│   │   ├── simulations/        # TBS simulations
│   │   ├── exam-simulation/    # Timed exams
│   │   ├── readiness/          # Prime Meridian score
│   │   └── ...
│   ├── login/, signup/         # Auth pages
│   └── ...
├── components/
│   ├── auth/
│   │   ├── AuthProvider.tsx    # Auth context with graceful degradation
│   │   └── AuthErrorBanner.tsx # Error UI (NEW)
│   ├── ErrorBoundary.tsx       # React error boundary (NEW)
│   └── ...
└── lib/
    ├── errorTracking.ts        # Centralized error tracking (NEW)
    ├── supabase/               # Supabase client/server/middleware
    ├── data/
    │   ├── practice-questions/ # MCQ files
    │   └── tbs/                # TBS files
    └── ...

================================================================================
TBS QUESTION GUIDELINES
================================================================================

**BATCH SIZE LIMIT: 10 questions max per batch**

TBS TYPES:
- numeric_entry: Calculate and enter values
- document_review: Review documents, identify errors
- journal_entry: Create journal entries
- dropdown: Select from options
- research: Find authoritative citations

CONTENT AREAS:
- FAR: FAR-I, FAR-II, FAR-III, FAR-IV
- AUD: AUD-I, AUD-II, AUD-III, AUD-IV
- REG: REG-I, REG-II, REG-III, REG-IV, REG-V
- TCP: TCP-I, TCP-II, TCP-III, TCP-IV
- BAR: BAR-I, BAR-II, BAR-III
- ISC: ISC-I, ISC-II, ISC-III

================================================================================
DATABASE MIGRATIONS (Outstanding)
================================================================================

**TBS Tracking Migration (if not already run):**
```sql
-- Run in Supabase SQL Editor
ALTER TABLE tbs_attempts
ADD COLUMN IF NOT EXISTS section TEXT CHECK (section IN ('FAR', 'AUD', 'REG', 'TCP', 'BAR', 'ISC'));

ALTER TABLE tbs_attempts
ALTER COLUMN tbs_id TYPE TEXT USING tbs_id::TEXT;

CREATE INDEX IF NOT EXISTS idx_tbs_attempts_section ON tbs_attempts(section);
CREATE INDEX IF NOT EXISTS idx_tbs_attempts_user_section ON tbs_attempts(user_id, section);
```

**Practice Achievements Migration (if not already run):**
```sql
-- Run: supabase/migrations/20260112_add_practice_achievements.sql
```

================================================================================
GOLDEN RULES
================================================================================

1. SESSION FILES ARE LOCAL - don't push to GitHub every update
2. READ DOCS BEFORE TBS WORK - check CLAUDE.md for type definitions
3. ALWAYS run `npm run build` before committing code
4. PREFER editing existing files over creating new ones
5. Use CSS variables for colors (see globals.css)
6. Include Claude Code + Happy attribution in commits

================================================================================
ERROR TRACKING (NEW 2026-01-16)
================================================================================

**To add Sentry for production error tracking:**
```bash
npx @sentry/wizard@latest -i nextjs
```
Then update src/lib/errorTracking.ts to use Sentry instead of console logging.

**Current error tracking functions:**
- captureException(error, context) - Track exceptions
- captureMessage(message, level) - Track non-exception events
- trackAuthError(action, message, extra) - Auth-specific errors
- trackApiError(endpoint, status, message, extra) - API errors
- setUser(id, email) - Set user context for correlation

================================================================================
END OF SESSION PROMPT
================================================================================
